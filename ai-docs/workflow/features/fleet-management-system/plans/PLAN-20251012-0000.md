# Fleet Management System Implementation Plan

**Feature ID:** fleet-management-system
**Plan Date:** 2025-10-12
**Complexity:** High (Greenfield multi-service architecture)
**Estimated Scope:** 50+ files, 8-12 week timeline

---

## Executive Summary

This plan outlines the implementation of a modern fleet management platform as a greenfield project within the budget-agentic-workflow template. The system will provide real-time GPS tracking, driver management, predictive maintenance, and compliance tracking for fleet operators. The architecture leverages cloud-native microservices, event-driven patterns, and multi-tenant design to support scalability from small fleets (10-50 vehicles) to enterprise deployments (1000+ vehicles).

**Core Value Proposition:**
- **Operational Efficiency:** 10-15% reduction in fuel costs through route optimization and idle time monitoring
- **Safety Improvement:** Driver behavior scoring with real-time alerts reduces incidents by 20-30%
- **Regulatory Compliance:** Automated ELD/HOS tracking eliminates DOT violation risks
- **Predictive Maintenance:** AI-powered forecasting reduces unplanned downtime by 25%

**Strategic Decision:** Start with MVP focused on small-to-medium fleets (10-200 vehicles) before scaling to enterprise. This allows validation of core features and compliance requirements with manageable data volumes.

---

## 1. Requirements Analysis

### 1.1 Problem Statement
Fleet operators lack integrated visibility into vehicle location, driver behavior, maintenance needs, and compliance status. Current solutions are either:
- **Too expensive** (enterprise-grade systems cost $30-50/vehicle/month)
- **Too fragmented** (using separate tools for GPS, maintenance, compliance)
- **Too complex** (steep learning curve, poor mobile experience)

### 1.2 Success Criteria
1. **Performance:** Real-time GPS updates with <5 second latency for 1000+ vehicles
2. **Reliability:** 99.5% uptime SLA, zero data loss for compliance records
3. **Usability:** Fleet managers can onboard new vehicles in <5 minutes
4. **Compliance:** ELD system passes FMCSA self-certification requirements
5. **ROI:** Customers achieve positive ROI within 6-12 months

### 1.3 Scope Definition

#### MVP Features (Phase 1 - 8 weeks)
- [x] **Vehicle Management:** CRUD for vehicles (VIN, make/model, registration)
- [x] **Driver Management:** Profiles, license tracking, assignments
- [x] **Real-time GPS Tracking:** Live map view with 30-second position updates
- [x] **Trip History:** Historical routes with replay functionality
- [x] **Geofencing:** Create zones, entry/exit alerts
- [x] **Basic Reporting:** Mileage, idle time, speeding events
- [x] **Mobile App (Driver):** Trip logging, HOS status, navigation
- [x] **Multi-tenancy:** Organization-level data isolation

#### Phase 2 Features (4 weeks)
- [ ] **Preventive Maintenance:** Mileage/time-based service reminders
- [ ] **Fuel Management:** Transaction import from fuel card APIs
- [ ] **Advanced Telematics:** OBD-II integration for engine diagnostics
- [ ] **Driver Behavior Scoring:** Harsh braking, acceleration, cornering metrics
- [ ] **Custom Dashboards:** User-configurable widget layouts

#### Phase 3 Features (Future)
- [ ] **Predictive Maintenance:** ML models for component failure forecasting
- [ ] **Route Optimization:** Multi-stop dispatching with traffic awareness
- [ ] **Video Telematics:** AI dashcam integration
- [ ] **EV Fleet Support:** Charge state, station locators

#### Explicitly Out of Scope (MVP)
- Video telematics / dashcam integration
- Third-party ERP/CRM integrations (Salesforce, SAP)
- White-label/multi-brand deployments
- International compliance (focus U.S. DOT/FMCSA only)

---

## 2. Technical Architecture

### 2.1 System Design Philosophy
**Event-Driven Microservices with API Gateway**

```
┌─────────────────────────────────────────────────────────────┐
│                         API Gateway                          │
│                    (Authentication, Rate Limiting)           │
└────────────┬────────────────────────────────────────────────┘
             │
    ┌────────┴────────┬──────────┬──────────┬──────────┬───────┐
    │                 │          │          │          │       │
┌───▼────┐  ┌────▼─────┐  ┌───▼────┐  ┌──▼───┐  ┌───▼────┐ ┌─▼──┐
│Vehicle │  │ Driver   │  │Tracking│  │Alerts│  │Reports │ │Auth│
│Service │  │ Service  │  │Service │  │      │  │Service │ │    │
└───┬────┘  └────┬─────┘  └───┬────┘  └──┬───┘  └───┬────┘ └────┘
    │            │            │          │          │
    └────────────┴────────────┴──────────┴──────────┘
                              │
                      ┌───────▼────────┐
                      │  Message Queue │
                      │   (RabbitMQ)   │
                      └───────┬────────┘
                              │
                    ┌─────────▼──────────┐
                    │  Event Processor   │
                    │ (Stream Analytics) │
                    └─────────┬──────────┘
                              │
              ┌───────────────┴────────────────┐
              │                                │
        ┌─────▼──────┐                 ┌──────▼──────┐
        │ PostgreSQL │                 │   Redis     │
        │ (Primary)  │                 │   (Cache)   │
        └────────────┘                 └─────────────┘
```

**Key Architectural Decisions:**
1. **Microservices over monolith:** Independent deployment, scaling, and failure isolation
2. **Event sourcing for location data:** Append-only log for audit trail and replay
3. **CQRS for reporting:** Separate read models optimized for analytics queries
4. **Redis caching:** Sub-second dashboard load times for active vehicle lists
5. **PostgreSQL with TimescaleDB:** Time-series extension for GPS/telematics data

### 2.2 Technology Stack

#### Backend
- **API Gateway:** Node.js + Express (or Fastify for performance)
- **Services:** Node.js microservices (consider Go for tracking service if performance becomes critical)
- **Message Queue:** RabbitMQ (simpler ops than Kafka for MVP scale)
- **Database:** PostgreSQL 15+ with TimescaleDB extension
- **Cache:** Redis 7+ (shared across services)
- **Authentication:** JWT with refresh tokens, bcrypt password hashing

#### Frontend
- **Web Dashboard:** React 18+ with TypeScript
- **State Management:** React Query + Zustand (lighter than Redux)
- **Maps:** Mapbox GL JS (better performance than Google Maps for large datasets)
- **UI Framework:** Tailwind CSS + shadcn/ui components

#### Mobile
- **Framework:** React Native (code reuse with web dashboard)
- **Offline Storage:** WatermelonDB (SQLite wrapper optimized for React Native)
- **Navigation:** React Navigation v6

#### DevOps
- **Hosting:** AWS (ECS for services, RDS for Postgres, ElastiCache for Redis)
- **CI/CD:** GitHub Actions
- **Monitoring:** CloudWatch + Sentry for error tracking
- **Infrastructure as Code:** Terraform

### 2.3 Data Model

#### Core Entities

**Organizations (Multi-Tenancy)**
```sql
CREATE TABLE organizations (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  plan_tier VARCHAR(50), -- 'starter', 'professional', 'enterprise'
  max_vehicles INT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  settings JSONB -- feature flags, notification preferences
);
```

**Vehicles**
```sql
CREATE TABLE vehicles (
  id UUID PRIMARY KEY,
  organization_id UUID REFERENCES organizations(id),
  vin VARCHAR(17) UNIQUE,
  make VARCHAR(100),
  model VARCHAR(100),
  year INT,
  license_plate VARCHAR(20),
  odometer_reading INT, -- miles
  status VARCHAR(20), -- 'active', 'maintenance', 'retired'
  assigned_driver_id UUID REFERENCES drivers(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_vehicles_org ON vehicles(organization_id);
```

**Drivers**
```sql
CREATE TABLE drivers (
  id UUID PRIMARY KEY,
  organization_id UUID REFERENCES organizations(id),
  email VARCHAR(255) UNIQUE,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  license_number VARCHAR(50),
  license_expiry DATE,
  phone VARCHAR(20),
  status VARCHAR(20), -- 'active', 'inactive', 'suspended'
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_drivers_org ON drivers(organization_id);
```

**Trips (with TimescaleDB hypertable)**
```sql
CREATE TABLE trips (
  id UUID,
  organization_id UUID REFERENCES organizations(id),
  vehicle_id UUID REFERENCES vehicles(id),
  driver_id UUID REFERENCES drivers(id),
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ,
  start_location GEOGRAPHY(POINT),
  end_location GEOGRAPHY(POINT),
  distance_miles DECIMAL(10,2),
  duration_seconds INT,
  avg_speed_mph DECIMAL(5,2),
  max_speed_mph DECIMAL(5,2),
  idle_time_seconds INT,
  fuel_consumed_gallons DECIMAL(8,2),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
-- Convert to hypertable for time-series optimization
SELECT create_hypertable('trips', 'start_time');
CREATE INDEX idx_trips_vehicle ON trips(vehicle_id, start_time DESC);
```

**GPS Positions (Event Stream)**
```sql
CREATE TABLE gps_positions (
  id BIGSERIAL,
  organization_id UUID,
  vehicle_id UUID,
  timestamp TIMESTAMPTZ NOT NULL,
  location GEOGRAPHY(POINT),
  speed_mph DECIMAL(5,2),
  heading DECIMAL(5,2), -- degrees
  altitude_feet INT,
  satellites INT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
SELECT create_hypertable('gps_positions', 'timestamp');
-- Compress old data (>7 days) for storage efficiency
SELECT add_compression_policy('gps_positions', INTERVAL '7 days');
```

**Geofences**
```sql
CREATE TABLE geofences (
  id UUID PRIMARY KEY,
  organization_id UUID REFERENCES organizations(id),
  name VARCHAR(255),
  geometry GEOGRAPHY(POLYGON), -- PostGIS type
  alert_on_entry BOOLEAN DEFAULT false,
  alert_on_exit BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_geofences_geometry ON geofences USING GIST(geometry);
```

**Alerts**
```sql
CREATE TABLE alerts (
  id UUID PRIMARY KEY,
  organization_id UUID,
  vehicle_id UUID,
  driver_id UUID,
  alert_type VARCHAR(50), -- 'speeding', 'geofence_exit', 'maintenance_due'
  severity VARCHAR(20), -- 'info', 'warning', 'critical'
  message TEXT,
  acknowledged BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_alerts_org_unacked ON alerts(organization_id, acknowledged, created_at);
```

### 2.4 API Design

#### RESTful Endpoints (API Gateway)

**Authentication**
- `POST /api/auth/register` - Create organization + admin user
- `POST /api/auth/login` - JWT token issuance
- `POST /api/auth/refresh` - Refresh token rotation

**Vehicles**
- `GET /api/vehicles` - List vehicles (paginated, filtered by org)
- `POST /api/vehicles` - Create vehicle
- `GET /api/vehicles/:id` - Get vehicle details
- `PATCH /api/vehicles/:id` - Update vehicle
- `DELETE /api/vehicles/:id` - Soft delete vehicle
- `GET /api/vehicles/:id/trips` - Trip history for vehicle

**Drivers**
- `GET /api/drivers` - List drivers
- `POST /api/drivers` - Create driver
- `GET /api/drivers/:id` - Get driver details
- `PATCH /api/drivers/:id` - Update driver

**Tracking**
- `GET /api/tracking/live` - Real-time positions (WebSocket upgrade)
- `GET /api/tracking/vehicles/:id/current` - Latest position for vehicle
- `GET /api/tracking/trips/:id/route` - GPS breadcrumb trail for trip replay

**Geofences**
- `GET /api/geofences` - List geofences
- `POST /api/geofences` - Create geofence (GeoJSON polygon)
- `DELETE /api/geofences/:id` - Delete geofence

**Alerts**
- `GET /api/alerts` - List alerts (unacknowledged first)
- `PATCH /api/alerts/:id/acknowledge` - Mark alert as seen

**Reports**
- `GET /api/reports/mileage` - Mileage summary (date range, by vehicle/driver)
- `GET /api/reports/idle-time` - Idle time analysis
- `GET /api/reports/speeding` - Speeding events log

#### WebSocket Events (Real-time)
- `vehicle:position` - GPS position update (30s interval)
- `alert:new` - New alert created
- `trip:started` - Trip begin event
- `trip:ended` - Trip completion event

### 2.5 Integration Strategy

#### GPS Hardware Simulation (MVP)
- Build mock GPS device simulator (`scripts/gps-simulator.js`)
- POST position updates to `POST /api/ingest/gps` endpoint
- Format: `{deviceId, timestamp, lat, lng, speed, heading}`
- Later: Add adapters for CalAmp, Teltonika protocols

#### Fuel Card APIs (Phase 2)
- WEX Fleet API for transaction imports
- Scheduled job (cron) pulls daily fuel purchases
- Match transactions to vehicles by license plate or card number

---

## 3. Implementation Phases

### Phase 1: Foundation & MVP (Weeks 1-8)

#### Week 1-2: Infrastructure Setup
**Tasks:**
1. Initialize monorepo structure (`/packages/api`, `/packages/web`, `/packages/mobile`)
2. Set up PostgreSQL + TimescaleDB + Redis locally (Docker Compose)
3. Configure ESLint/Prettier/TypeScript across all packages
4. Create Terraform modules for AWS resources (ECS, RDS, ElastiCache)
5. Set up GitHub Actions CI pipeline (lint, test, build)

**Deliverables:**
- `docker-compose.yml` for local development
- `terraform/` directory with modular AWS infrastructure
- `.github/workflows/ci.yml` for automated checks

**Tool Delegation:** Codex MCP for boilerplate (Docker configs, Terraform modules, ESLint setup)

---

#### Week 3-4: Core Services & Authentication
**Tasks:**
1. **Auth Service:**
   - User registration with bcrypt password hashing
   - JWT token generation (access + refresh)
   - Middleware for token validation
   - Role-based access control (admin, manager, driver)

2. **Vehicle Service:**
   - CRUD endpoints for vehicles table
   - Soft delete implementation
   - Pagination with cursor-based approach
   - Input validation with Zod schemas

3. **Driver Service:**
   - CRUD endpoints for drivers table
   - License expiry validation
   - Driver-vehicle assignment logic

**Deliverables:**
- `packages/api/src/services/auth/` with JWT utilities
- `packages/api/src/services/vehicles/` with REST endpoints
- `packages/api/src/services/drivers/` with REST endpoints
- Unit tests with 80%+ coverage (Jest)

**Tool Delegation:** Codex MCP for CRUD boilerplate + test scaffolding

---

#### Week 5-6: GPS Tracking & Geofencing
**Tasks:**
1. **Tracking Service:**
   - Ingest endpoint for GPS positions (`POST /api/ingest/gps`)
   - WebSocket server for real-time position streaming
   - Trip detection algorithm (start = ignition on, end = 5min idle)
   - TimescaleDB hypertable setup for `gps_positions`
   - Redis caching for latest vehicle positions

2. **Geofence Service:**
   - PostGIS setup for polygon storage
   - Point-in-polygon checks on GPS events
   - Alert generation on geofence violations
   - RabbitMQ integration for alert events

**Deliverables:**
- `packages/api/src/services/tracking/` with WebSocket server
- `packages/api/src/services/geofences/` with PostGIS queries
- GPS simulator script (`scripts/gps-simulator.js`)
- Performance test: 1000 concurrent vehicles, <5s latency

**Tool Delegation:** Claude for geofencing algorithms (complex spatial logic)

---

#### Week 7-8: Web Dashboard & Mobile App
**Tasks:**
1. **Web Dashboard:**
   - React app with TypeScript + Vite
   - Mapbox GL JS integration for live map view
   - Vehicle clustering for zoom levels
   - Trip history page with route replay
   - Geofence drawing UI (polygon tool)
   - Alert notification UI (toast messages)
   - Responsive design (desktop + tablet)

2. **Mobile App (Driver):**
   - React Native setup with Expo
   - Login flow with JWT storage (secure storage)
   - Trip logging (manual start/stop for MVP)
   - Push notifications for alerts (Expo Push Notifications)

**Deliverables:**
- `packages/web/` with React dashboard
- `packages/mobile/` with React Native app
- E2E tests for critical flows (Playwright for web)

**Tool Delegation:** Codex MCP for React components + UI forms

---

### Phase 2: Advanced Features (Weeks 9-12)

#### Week 9-10: Maintenance & Fuel Management
**Tasks:**
1. **Maintenance Service:**
   - Service schedules table (mileage/time triggers)
   - Automated reminder notifications (email + in-app)
   - Service history log (date, cost, odometer reading)
   - Dashboard widget for overdue maintenance

2. **Fuel Management:**
   - WEX API integration (OAuth 2.0 flow)
   - Daily transaction sync job
   - Fuel cost analytics ($/mile, trends over time)
   - Dashboard fuel consumption charts (Chart.js)

**Deliverables:**
- `packages/api/src/services/maintenance/` with cron jobs
- `packages/api/src/services/fuel/` with WEX adapter
- Fuel analytics dashboard page

**Tool Delegation:** Codex MCP for API integrations + cron jobs

---

#### Week 11-12: Advanced Telematics & Driver Scoring
**Tasks:**
1. **OBD-II Integration:**
   - Mock OBD-II data generator (engine diagnostics codes)
   - DTC (Diagnostic Trouble Code) parsing and severity classification
   - Real-time dashboard health indicators

2. **Driver Behavior Scoring:**
   - Harsh event detection (acceleration >8mph/s, braking >8mph/s)
   - Cornering detection (lateral G-force estimation from GPS)
   - Weekly driver scorecards (0-100 scale)
   - Coaching recommendations

**Deliverables:**
- `packages/api/src/services/telematics/` with OBD-II parser
- `packages/api/src/services/scoring/` with event detection algorithms
- Driver scorecard UI page

**Tool Delegation:** Claude for scoring algorithms (complex math + domain logic)

---

### Phase 3: Compliance & Optimization (Future)

#### ELD/HOS Compliance
- Hours of Service rules engine (FMCSA Part 395)
- Electronic logbook with duty status changes
- FMCSA self-certification documentation
- Automated DVIR (Driver Vehicle Inspection Report)

#### Route Optimization
- Multi-stop route planning (traveling salesman problem)
- Traffic-aware ETAs (Google Maps API integration)
- Dispatch assignment optimization

---

## 4. Testing Strategy

### 4.1 Unit Testing
- **Target:** 80%+ code coverage on business logic
- **Framework:** Jest + ts-jest for TypeScript
- **Focus Areas:**
  - Trip detection logic (start/end conditions)
  - Geofence violation detection (point-in-polygon)
  - Driver scoring calculations
  - JWT token validation

**Example Test:**
```typescript
describe('Trip Detection', () => {
  it('should start trip when vehicle speed exceeds 5mph', () => {
    const positions = [
      { speed: 0, timestamp: '2025-01-01T10:00:00Z' },
      { speed: 10, timestamp: '2025-01-01T10:00:30Z' }
    ];
    const trip = detectTrip(positions);
    expect(trip.startTime).toEqual('2025-01-01T10:00:30Z');
  });
});
```

### 4.2 Integration Testing
- **Framework:** Supertest for API endpoint testing
- **Scope:**
  - Auth flow (register → login → token refresh)
  - Vehicle CRUD with database persistence
  - GPS ingest → trip creation → WebSocket broadcast
  - Geofence entry → alert generation → notification delivery

**Setup:** Test database with fixtures, teardown after each test

### 4.3 E2E Testing
- **Web:** Playwright (visual regression + user flows)
  - Fleet manager creates vehicle → assigns driver → views on map
  - Geofence creation → vehicle entry → alert appears
- **Mobile:** Detox (React Native E2E framework)
  - Driver logs in → starts trip → stops trip → views history

### 4.4 Performance Testing
- **Tool:** k6 for load testing
- **Scenarios:**
  1. 1000 concurrent GPS position updates (target: <5s p95 latency)
  2. 100 concurrent dashboard loads (target: <2s page load)
  3. 10,000 historical trip queries (target: <1s p95)

**Acceptance Criteria:** No degradation under 2x expected load

### 4.5 Security Testing
- **Manual Checks:**
  - SQL injection attempts on search filters
  - JWT tampering (expired tokens, modified claims)
  - Cross-tenant data leakage (org A accessing org B's data)
- **Automated:** OWASP ZAP scan in CI pipeline

---

## 5. Deployment Strategy

### 5.1 Environment Setup

**Local Development:**
- Docker Compose with hot-reload (nodemon for API, Vite HMR for web)
- Seed data script (`npm run db:seed`) for demo vehicles/drivers

**Staging (AWS):**
- ECS Fargate for services (auto-scaling 2-10 tasks)
- RDS PostgreSQL Multi-AZ (automated backups, 7-day retention)
- ElastiCache Redis (cluster mode disabled for simplicity)
- ALB (Application Load Balancer) with TLS termination

**Production (AWS):**
- Same as staging + CloudFront CDN for web dashboard
- RDS read replicas for reporting queries
- Enhanced monitoring (CloudWatch alarms, Sentry error tracking)

### 5.2 CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [main]

jobs:
  test:
    - Run lint, unit tests, integration tests

  build:
    - Build Docker images for API services
    - Build static web dashboard
    - Upload artifacts to S3

  deploy-staging:
    - Terraform apply (staging environment)
    - ECS task definition update
    - Run smoke tests

  deploy-production:
    - Manual approval gate
    - Terraform apply (production environment)
    - Blue/green deployment with ECS
    - Monitor error rates for 10 minutes
    - Rollback on failure
```

### 5.3 Database Migrations
- **Tool:** node-pg-migrate
- **Process:**
  1. Local: `npm run migrate:up` to apply new migrations
  2. CI: Automated migration on staging deploy
  3. Production: Manual review + migration during maintenance window

**Critical:** Always write reversible migrations (`up` + `down` functions)

### 5.4 Monitoring & Alerting

**Metrics to Track:**
- API latency (p50, p95, p99)
- Error rate (5xx responses)
- Database connection pool saturation
- Redis cache hit rate
- WebSocket connection count
- GPS position ingestion rate (positions/second)

**Alerts:**
- PagerDuty for critical issues (database down, API errors >5%)
- Slack for warnings (latency spike, cache miss rate >20%)

---

## 6. Security Considerations

### 6.1 Authentication & Authorization
- **Password Security:** bcrypt with 12 rounds (vs plain text or weak hashing)
- **JWT Best Practices:**
  - Short-lived access tokens (15 minutes)
  - Long-lived refresh tokens (7 days) with rotation
  - Store refresh tokens in secure HTTP-only cookies (not localStorage)
- **Role-Based Access Control:**
  - Admin: Full organization access
  - Manager: Assigned vehicle groups only
  - Driver: Own trips and HOS logs only

### 6.2 Data Protection
- **Encryption in Transit:** TLS 1.2+ for all API communication
- **Encryption at Rest:** AWS RDS encryption enabled
- **PII Handling:**
  - Driver license numbers encrypted with AES-256
  - Audit log for all PII access (GDPR compliance)
- **Multi-Tenancy Isolation:**
  - Row-level security (RLS) in PostgreSQL
  - Every query filtered by `organization_id`
  - Automated test suite for cross-tenant leakage

### 6.3 Input Validation
- **Zod schemas** for all API inputs (type safety + runtime validation)
- **Parameterized queries** (prevent SQL injection)
- **Rate limiting** (100 requests/minute per user)

### 6.4 Compliance Requirements

**FMCSA ELD Mandate (if pursuing Phase 3):**
- Self-certification on FMCSA registry
- Malfunction reporting (8 diagnostic events, 6 malfunction events)
- Data transfer protocol (Bluetooth, email, web services)

**GDPR (if serving EU customers):**
- Right to access (export driver data on request)
- Right to erasure (anonymize trip data after account deletion)
- Data processing agreements with subprocessors (AWS, Mapbox)

---

## 7. Risk Assessment

### 7.1 Technical Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **Real-time data volume overwhelms system** | Medium | High | Horizontal scaling with RabbitMQ, batch GPS position inserts (every 30s vs real-time), Redis caching |
| **GPS hardware integration complexity** | High | Medium | Start with simulated devices, build adapters incrementally, prioritize 2-3 popular hardware vendors |
| **Mobile offline mode data conflicts** | Medium | Medium | Implement conflict resolution strategy (last-write-wins with timestamps), test edge cases rigorously |
| **PostgreSQL write bottleneck** | Low | High | Use TimescaleDB compression, partition trip data by month, read replicas for reports |
| **WebSocket connection scaling** | Medium | Medium | Use AWS ECS with ALB sticky sessions, consider Redis Pub/Sub for cross-instance messaging |

### 7.2 Business Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **Regulatory compliance failure** | Medium | Critical | Engage legal counsel early, follow FMCSA technical specifications exactly, third-party audit before launch |
| **Market competition from incumbents** | High | High | Focus on SMB market (under-served by Samsara/Geotab), differentiate on ease of use + pricing |
| **Customer churn due to poor UX** | Medium | High | User testing with 5-10 beta customers before public launch, iterate based on feedback |
| **Data privacy incident** | Low | Critical | Penetration testing, bug bounty program, cyber insurance policy |

### 7.3 Open Questions Requiring User Input

Before proceeding with implementation, clarify:

1. **Target Market:** Small fleets (10-50 vehicles), mid-market (50-200), or enterprise (1000+)?
   - *Impact:* Determines architecture scale decisions (single DB vs sharding, caching strategy)

2. **Industry Vertical:** General purpose, long-haul trucking, last-mile delivery, service vehicles?
   - *Impact:* Affects feature prioritization (ELD compliance critical for trucking, route optimization for delivery)

3. **Compliance Scope:** U.S. DOT/FMCSA only, or international (EU tachograph regulations)?
   - *Impact:* ELD certification is U.S.-specific; EU has different requirements

4. **Build vs. Buy Decision:** Custom platform or integrate with existing telematics providers (Geotab API)?
   - *Impact:* Integration approach reduces development time but limits differentiation

5. **MVP Launch Timeline:** 8-week aggressive timeline or 12-week with buffer?
   - *Impact:* Determines whether Phase 2 features are included in initial release

6. **Pricing Model:** Per-vehicle/month SaaS, one-time license fee, or freemium with premium features?
   - *Impact:* Affects multi-tenancy design (usage-based billing requires metering infrastructure)

---

## 8. Token Budget & Tool Delegation

### 8.1 Estimated Token Usage by Phase

| Phase | Claude (Architecture) | Codex (Implementation) | Gemini (Docs) | Total |
|-------|----------------------|------------------------|---------------|-------|
| Infrastructure Setup | 10K | 30K | 5K | 45K |
| Core Services | 20K | 50K | 10K | 80K |
| GPS Tracking | 30K | 40K | 5K | 75K |
| Web/Mobile UI | 15K | 60K | 10K | 85K |
| Phase 2 Features | 25K | 50K | 5K | 80K |
| **Total** | **100K** | **230K** | **35K** | **365K** |

**Budget Notes:**
- Exceeds single-week limit (200K) → Spread over 2-3 weeks
- Heavy Codex delegation for CRUD/UI keeps Claude usage low
- Gemini handles all documentation summarization

### 8.2 Delegation Strategy

**Use Codex MCP for:**
- Database models and migrations
- REST API CRUD endpoints
- React components (forms, tables, modals)
- Test boilerplate (fixtures, mocks)
- Docker/Terraform configuration files

**Use Claude for:**
- Trip detection algorithms (complex business logic)
- Geofencing point-in-polygon calculations
- Driver scoring formulas
- Multi-service orchestration decisions
- Security review (JWT implementation, SQL injection prevention)

**Use Gemini MCP for:**
- Reading WEX API documentation
- Summarizing FMCSA ELD specifications
- Researching Mapbox GL JS best practices

---

## 9. Success Metrics & Validation

### 9.1 Technical KPIs

**Performance:**
- [ ] GPS position ingestion: >500 positions/second sustained
- [ ] Dashboard load time: <2s (p95)
- [ ] Real-time map updates: <5s latency (p95)
- [ ] API error rate: <0.1%

**Reliability:**
- [ ] Uptime: 99.5% (max 3.6 hours downtime/month)
- [ ] Zero data loss for compliance-critical records (HOS logs, trip history)

**Code Quality:**
- [ ] Unit test coverage: >80%
- [ ] Zero critical security vulnerabilities (OWASP Top 10)
- [ ] Lighthouse score >90 for web dashboard

### 9.2 Business KPIs (Post-Launch)

**Adoption:**
- [ ] 50 beta customers within 3 months
- [ ] 80%+ user retention month-over-month

**ROI Validation:**
- [ ] Customers report 10%+ fuel cost reduction (survey after 6 months)
- [ ] 50%+ reduction in manual HOS paperwork time (driver interviews)

**Compliance:**
- [ ] Zero DOT violations attributed to system errors
- [ ] FMCSA self-certification approval (if pursuing ELD)

### 9.3 Validation Checkpoints

**Before Phase 2:**
- [ ] 10 beta users tested MVP for 2+ weeks
- [ ] User feedback survey (SUS score >70)
- [ ] Performance testing passed under 2x expected load
- [ ] Security audit completed (no critical findings)

**Before Production Launch:**
- [ ] Penetration testing by third-party firm
- [ ] Legal review of terms of service and data privacy policy
- [ ] Customer support runbook documented
- [ ] Disaster recovery plan tested (database restore, failover)

---

## 10. Next Steps & Execution Plan

### 10.1 Immediate Actions (Before /build)

1. **User Confirmation:**
   - Review this plan and answer open questions (Section 7.3)
   - Approve scope (MVP only, or include Phase 2 features?)
   - Confirm timeline (8-week aggressive vs 12-week with buffer)

2. **Environment Setup:**
   - Install required tools (Docker, Node 18+, PostgreSQL, Redis)
   - Create AWS account and configure Terraform backend (S3 + DynamoDB)
   - Set up GitHub repository with branch protection rules

3. **Documentation:**
   - Create `app-docs/specs/active/fleet-management-system.md` (detailed feature spec)
   - Draft `app-docs/architecture/fleet-management-architecture.md` (system diagrams)
   - Add compliance research to `app-docs/guides/fleet-management-compliance.md`

### 10.2 Recommended Build Command

Once approved, execute with detailed reporting:

```bash
/build_w_report "ai-docs/workflow/features/fleet-management-system/plans/PLAN-20251012-0000.md"
```

**Why `/build_w_report`?**
- Generates comprehensive build report with file changes
- Updates `app-docs/mappings/feature-to-source.md` automatically
- Provides token usage breakdown for budget tracking

### 10.3 Post-Build Validation

After implementation:
1. Run test suite: `npm test`
2. Check build report: `ai-docs/builds/[timestamp]-fleet-management-system/build-report.md`
3. Manual testing:
   - Create test organization and vehicles
   - Run GPS simulator: `node scripts/gps-simulator.js`
   - Verify real-time map updates
   - Test geofence alerts
4. Review git diff: `git diff --stat`
5. If tests pass → `/deploy_staging`

---

## 11. Appendix

### 11.1 Reference Documentation

**Technical Standards:**
- [FMCSA ELD Technical Specifications](https://www.fmcsa.dot.gov/regulations/rulemaking/2015-24014)
- [GPS NMEA 0183 Protocol](http://aprs.gids.nl/nmea/) (for hardware integration)
- [GeoJSON Specification](https://geojson.org/) (geofence format)

**Third-Party APIs:**
- [Mapbox GL JS Documentation](https://docs.mapbox.com/mapbox-gl-js/api/)
- [WEX Fleet API](https://developer.wexinc.com/) (fuel card integration)
- [Expo Push Notifications](https://docs.expo.dev/push-notifications/overview/)

**Database Performance:**
- [TimescaleDB Best Practices](https://docs.timescale.com/timescaledb/latest/how-to-guides/)
- [PostGIS Spatial Queries](https://postgis.net/docs/reference.html)

### 11.2 Sample Data for Testing

**GPS Simulator Output:**
```json
{
  "deviceId": "vehicle-001",
  "timestamp": "2025-01-15T14:23:00Z",
  "location": {
    "lat": 37.7749,
    "lng": -122.4194
  },
  "speed": 45.5,
  "heading": 180,
  "altitude": 50,
  "satellites": 12
}
```

**Geofence GeoJSON:**
```json
{
  "type": "Feature",
  "properties": {
    "name": "San Francisco Warehouse",
    "alertOnEntry": true,
    "alertOnExit": true
  },
  "geometry": {
    "type": "Polygon",
    "coordinates": [[
      [-122.4194, 37.7749],
      [-122.4150, 37.7749],
      [-122.4150, 37.7700],
      [-122.4194, 37.7700],
      [-122.4194, 37.7749]
    ]]
  }
}
```

### 11.3 Decision Log

**Architectural Decisions Made:**
1. **TimescaleDB over InfluxDB:** Better integration with existing PostgreSQL expertise, supports relational queries alongside time-series
2. **React Native over native iOS/Android:** Faster MVP delivery, code reuse with web dashboard
3. **RabbitMQ over Kafka:** Simpler operations for MVP scale, easier local development setup
4. **Mapbox over Google Maps:** Better pricing for high-volume position updates, superior clustering performance

**Deferred Decisions (Require More Research):**
1. GPS hardware vendor selection (pending market research)
2. EV fleet support architecture (depends on customer demand)
3. White-label multi-brand deployment (future scalability concern)

---

## Summary

This plan provides a comprehensive blueprint for implementing a production-ready fleet management system from scratch. The phased approach allows for MVP validation before committing to advanced features, while the token-optimized delegation strategy keeps development costs manageable.

**Critical Success Factors:**
1. **User feedback loop:** Beta testing with real fleet operators before scaling
2. **Compliance diligence:** Legal review of ELD requirements before claiming certification
3. **Performance testing:** Validate real-time system under 2x expected load
4. **Security hardening:** Third-party penetration testing before production launch

**Estimated Delivery Timeline:**
- MVP (Phase 1): 8 weeks with full-time effort
- Phase 2 features: Additional 4 weeks
- Production hardening & launch: 2 weeks

**Total Token Budget:** 365K tokens (spread over 2-3 weeks within Claude Code's 200K weekly limit)

**Recommended Next Step:** User approval of scope + open questions → `/build_w_report` execution

---

**Plan saved to:** `ai-docs/workflow/features/fleet-management-system/plans/PLAN-20251012-0000.md`
**Documentation scraped:** None (no external URLs provided)
**Ready for build phase:** Pending user approval
